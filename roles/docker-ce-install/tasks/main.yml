# https://docs.docker.com/install/linux/docker-ce/centos/

# add 'ansible-playbook --tags remove-old-docker,all' option to run this
- name: uninstall old version of docker
  yum:
    name="{{ packages }}"
    state=absent
  vars:
    packages:
      - docker
      - docker-client
      - docker-client-latest
      - docker-common
      - docker-latest
      - docker-latest-logrotate
      - docker-logrotate
      - docker-selinux
      - docker-engine-selinux
      - docker-engine
  tags: [ never, remove-old-docker ]

- name: install required packages
  yum:
    name="{{ packages }}"
  vars:
    packages:
#      - yum-utils # it only required for yum-config-manager
      - device-mapper-persistent-data
      - lvm2

- name: setup repository
  command: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo


- name: install docker ce
  yum:
    name=docker-ce-18.06.2.ce
    state=present

- name: create /etc/docker directory
  file: path=/etc/docker state=directory

- name: setup deamon (reset daemon.json)
  file: path=/etc/docker/daemon.json state=absent
# https://kubernetes.io/docs/setup/production-environment/container-runtimes/#docker
# disable this configuration described in the documents
# to avoid restarting docker when the insecure registry added later
# kubelet fails after docker restarted:
#   Aug 29 08:45:21 master kubelet: F0829 08:45:21.696874   22527 server.go:273] failed to run Kubelet: failed to create kubelet: misconfiguration: kubelet cgroup driver: "cgroupfs" is different from docker cgroup driver: "systemd"
#- name: setup daemon
#  template:
#    src: daemon.json
#    dest: /etc/docker/daemon.json

- name: enable docker
  systemd:
    name: docker
    enabled: yes
    state: started


# Proxy configuration based on the documents
#   https://docs.docker.com/config/daemon/systemd/
# alternatives; setting /etc/sysconfig/docker may also works
#   https://docs.docker.com/network/proxy/
- name: proxy configuration directory (if configured)
  file: path=/etc/systemd/system/docker.service.d state=directory
  when: USE_PROXY is defined
- name: proxy configuration file (if configured)
  template:
    src: http-proxy.conf.j2
    dest: /etc/systemd/system/docker.service.d/http-proxy.conf
  when: USE_PROXY is defined
  notify: restart docker

#- name: reload systemd for docker proxy configuration
#  systemd:
#    daemon_reload: yes
#- name: restart docker for proxy configuration
#  systemd:
#    name: docker
#    state: restarted
#  changed_when: false

